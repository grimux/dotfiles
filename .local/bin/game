#!/usr/bin/env bash

# Game backup script

# Variables
save_locations=$HOME/.config/game/game_save_locations.txt
archive_locations=$HOME/.config/game/game_archive_locations.txt
temp_file=$HOME/.cache/game_save_temp.txt

# Functions
help_section() {
	echo "A script to manage game saves."
	echo
	echo "Syntax: game [-h|l] [command] (game name)"
	echo "options:"
	echo "h     Print this help screen."
	echo "l     List games."
	echo
	echo "commands:"
	echo "backup     Backup game saves"
	echo "archive    Compress game archives"
	echo "list       List games"
	echo
}

# List the tracked games and archives
list_games() {
	echo "=== Games ==="
	create_temp_file "$save_locations"
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		echo $game_title
	done < $temp_file
	remove_temp_file
	echo

	echo "=== Archives ==="
	create_temp_file "$archive_locations"
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		echo $game_title
	done < $temp_file
	#remove_temp_file
}

create_temp_file() {
	# sed command will ignore any line beginning with #
	# tr will replace multiple tab characters with a single ,
	# redirect this into my temp_file
	sed 's/\s*#.*$//;/^\s*$/d' $1 | tr -s "\t" "," > $temp_file
	#sed 's/\s*#.*$//;/^\s*$/d' $save_locations | tr -s "\t" "\n" > $temp_file
}

remove_temp_file() {
	rm -f $temp_file
}

read_file() {
	create_temp_file "$save_locations"
	mapfile -t -d'[\n]' game_array < $temp_file
	for i in "${game_array[@]}"; do
		echo $i
	done
	#remove_temp_file
}

backup_saves() {
	create_temp_file "$save_locations"
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		game_save=$(echo $line | awk -F',' '{print $2}')
		game_backup=$(echo $line | awk -F',' '{print $3}')
		echo "Backing up $game_title..."
		cp -r -p -v --update "$game_save/." "$game_backup" || echo "Nothing to do"
		#rsync -r -n --progress -t --delete --modify-window=1 "$game_save/" "$game_backup"
		echo
	done < $temp_file
	remove_temp_file
}

archive_saves() {
	echo "Archiving games..."
	echo
	create_temp_file "$archive_locations"
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		game_directory=$(echo $line | awk -F',' '{print $2}')
		game_archive=$(echo $line | awk -F',' '{print $3}')
		echo "Backing up $game_title..."
		7z u -up1q0r2x1y2z1w2 -mx9 -mmt16 "$game_archive" "$game_directory"
		echo
	done < $temp_file
	remove_temp_file
}

get_args() {
	while getopts ":hl" option; do
		case $option in
			h)
				help_section
				exit
				;;
			l)
				list_games
				exit
				;;
			\?)
				echo Error: invalid option
				exit 1
				;;
		esac
	done
}

main() {
	case "$1" in
		backup)
			backup_saves
			exit
			;;
	
		archive)
			archive_saves
			exit
			;;
		list)
			list_games
			exit
			;;
		test)
			read_file
			exit
			;;
		*)
			echo "Invalid command"
			exit 1
			;;
	esac
}

# Start main script
get_args "$@"
main "$@"
