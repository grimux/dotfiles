#!/usr/bin/env bash

# Game backup script

# Variables
save_locations=$HOME/.config/game/game_save_locations.txt
temp_file=$HOME/.config/game/temp.txt

# Functions
help_section() {
	echo "A script to manage game saves."
	echo
	echo "Syntax: game [-h|l] [command] (game name)"
	echo "options:"
	echo "h     Print this help screen."
	echo "l     List games."
	echo
	echo "commands:"
	echo "backup     Backup game saves"
	echo "archive    Compress game archives"
	echo "list       List games"
	echo
}

list_games() {
	create_temp_file
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		echo $game_title
	done < $temp_file
	remove_temp_file
}

create_temp_file() {
	# sed command will ignore any line beginning with #
	# tr will replace multiple tab characters with a single ,
	# redirect this into my temp_file
	sed 's/\s*#.*$//;/^\s*$/d' $save_locations | tr -s "\t" "," > $temp_file
}

remove_temp_file() {
	rm -f $temp_file
}

backup_saves() {
	echo "Backing up saves..."
	create_temp_file
	while read line; do
		game_title=$(echo $line | awk -F',' '{print $1}')
		game_save=$(echo $line | awk -F',' '{print $2}')
		game_backup=$(echo $line | awk -F',' '{print $3}')
		echo "Backing up $game_title..."
		cp -r -p -v --update "$game_save/." "$game_backup"
	done < $temp_file
	remove_temp_file
}

archive_saves() {
	echo "Archiving games..."
}

get_args() {
	while getopts ":hl" option; do
		case $option in
			h)
				help_section
				exit
				;;
			l)
				list_games
				exit
				;;
			\?)
				echo Error: invalid option
				exit 1
				;;
		esac
	done
}

main() {
	case "$1" in
		backup)
			backup_saves
			exit
			;;
	
		archive)
			archive_saves
			exit
			;;
		list)
			list_games
			exit
			;;
		*)
			echo "Invalid command"
			exit 1
			;;
	esac
}

# Start main script
get_args "$@"
main "$@"
